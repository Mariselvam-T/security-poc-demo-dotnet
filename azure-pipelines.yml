# .NET Desktop
# Build and run tests for .NET Desktop or Windows classic desktop solutions.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/windows/dot-net

trigger:
- main

pool:
  vmImage: 'Windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:
- task: NuGetToolInstaller@1

- task: NuGetCommand@2
  inputs:
    restoreSolution: '$(solution)'

- powershell: |
    Invoke-WebRequest -Uri https://github.com/github/codeql-action/releases/latest/download/codeql-bundle-win64.tar.gz -OutFile $(Agent.BuildDirectory)/s/codeql-bundle-win64.tar.gz
    tar -xvzf $(Agent.BuildDirectory)/s/codeql-bundle-win64.tar.gz
    echo current working directory
    pwd
    echo list directory
    ls
    #./codeql/codeql resolve qlpacks
    echo Agent build directory $(Agent.BuildDirectory)
    echo Agent HomeDirectory directory $(Agent.HomeDirectory)
    echo DefaultWorkingDirectory $(System.DefaultWorkingDirectory)
    mkdir 
  displayName: 'Download Codeql CLI package'

- task: CmdLine@2
  displayName: CodeQL Initialization
  inputs:
    script: |
      mkdir $(Agent.BuildDirectory)/s/codeql/codeql-dbs
      "codeql database init --language csharp --trace-process-name Agent.Worker.exe --source-root . --begin-tracing /codeql-dbs/sec-poc-demo-dotnet-repo"

- task: PowerShell@2
  displayName: Set CodeQL Environment Variables
  inputs:
   targetType: inline
   script: >
          $json = Get-Content $(System.DefaultWorkingDirectory)/codeql-runner/codeql-env.json | ConvertFrom-Json
          $json.PSObject.Properties | ForEach-Object {
              $template = "##vso[task.setvariable variable="
              $template += $_.Name
              $template += "]"
              $template += $_.Value
              echo "$template"
          }

# Execute a clean build using the VSBuild task.
- task: VSBuild@1
  inputs:
      solution: '**/*.sln'
      msbuildArgs: '/p:OutDir=$(Build.ArtifactStagingDirectory) /p:UseSharedCompilation=false'
      platform: Any CPU
      configuration: Release
      clean: True
  displayName: Visual Studio Build